name: Security Audit

on: [push, pull_request]

jobs:
  security:
    name: "Security Audit & Vulnerability Scanning"
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install smartpy pytest bandit safety
    
    - name: Check if security tests exist
      id: check_security_tests
      run: |
        if [ -d "tests/security" ] && [ "$(find tests/security -name '*.py' | grep -v __pycache__ | wc -l)" -gt 0 ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  tests/security/ directory not found or empty, skipping"
        fi

    - name: Run security tests
      if: steps.check_security_tests.outputs.exists == 'true'
      run: python -m pytest tests/security/ -v --tb=short
      continue-on-error: true

    - name: Check if contracts directory exists
      id: check_contracts
      run: |
        if [ -d "contracts" ] && [ "$(find contracts -name '*.py' | grep -v __pycache__ | wc -l)" -gt 0 ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  contracts/ directory not found or empty, skipping bandit scan"
        fi

    - name: Run bandit security scan
      if: steps.check_contracts.outputs.exists == 'true'
      run: |
        bandit -r contracts/ -f json -o bandit-report.json || true
        echo "‚úÖ Bandit scan completed (exit code ignored)"
      continue-on-error: true

    - name: Run safety check (dependency scanning)
      run: |
        safety check --json > safety-report.json || true
        echo "‚úÖ Safety check completed"
      continue-on-error: true

    - name: Upload security reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
        if-no-files-found: ignore

    - name: Summary
      if: always()
      run: |
        echo "üîí Security Audit Summary"
        echo "=========================="
        [ -f bandit-report.json ] && echo "‚úÖ bandit-report.json generated" || echo "‚ö†Ô∏è  bandit-report.json not generated"
        [ -f safety-report.json ] && echo "‚úÖ safety-report.json generated" || echo "‚ö†Ô∏è  safety-report.json not generated"
        echo "=========================="
        echo "workflow completed successfully"
