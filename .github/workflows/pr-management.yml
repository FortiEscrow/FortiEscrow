name: Auto-labeler & PR Management

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened]

jobs:
  label:
    name: "Auto-label Issues & PRs"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
    - name: Label PR by size
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const { data } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const lines = data.additions + data.deletions;
          let label = 'size/small';
          if (lines > 500) label = 'size/large';
          else if (lines > 100) label = 'size/medium';
          
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            labels: [label],
          });

    - name: Label by type
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const title = context.payload.pull_request.title.toLowerCase();
          let labels = [];
          
          if (title.includes('fix:')) labels.push('type/bug-fix');
          if (title.includes('feat:')) labels.push('type/feature');
          if (title.includes('docs:')) labels.push('type/documentation');
          if (title.includes('test:')) labels.push('type/testing');
          if (title.includes('refactor:')) labels.push('type/refactor');
          if (title.includes('chore:')) labels.push('type/maintenance');
          
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: labels,
            });
          }

  check-conventions:
    name: "Check PR Conventions"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check commit message format
      run: |
        # Check if PR title follows semantic versioning
        TITLE="${{ github.event.pull_request.title }}"
        if [[ ! $TITLE =~ ^(fix|feat|docs|test|refactor|chore|perf|ci|build|style)(\(.+\))?:\ .+ ]]; then
          echo "âŒ PR title does not follow conventional commits"
          echo "Expected format: type(scope): description"
          echo "Examples: fix: resolve voting block, feat(dispute): add arbiter resolution"
          exit 1
        fi
        echo "âœ… PR title follows semantic versioning"

    - name: Check branch naming
      run: |
        BRANCH="${{ github.head_ref }}"
        if [[ ! $BRANCH =~ ^(main|develop|hotfix|release|feature|bugfix)/.+ && $BRANCH != "main" && $BRANCH != "develop" ]]; then
          echo "âš ï¸  Branch name: $BRANCH"
          echo "Recommended format: type/description (e.g., feature/voting-during-disputes)"
        fi

    - name: Comment PR guidelines
      uses: actions/github-script@v6
      if: github.event.action == 'opened'
      with:
        script: |
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `## ğŸ“‹ PR Checklist
            
- [ ] Follows semantic commit format (\`type: description\`)
- [ ] All tests passing (38/40 target)
- [ ] Dispute mechanism tests validated
- [ ] Code coverage maintained (>75%)
- [ ] Security scan passed
- [ ] Documentation updated
- [ ] No breaking changes (or documented)

## ğŸ” Automated Checks
âœ… Commit format verified
âœ… Tests configured
âœ… Security scanning enabled
âœ… Documentation auto-generated

**Need help?** See [CONTRIBUTING.md](https://github.com/FortiEscrow/FortiEscrow/blob/main/CONTRIBUTING.md)`
          })
